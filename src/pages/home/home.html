<ion-header>
  <ion-navbar>
    <ion-title>Quotes & Bids</ion-title>
  </ion-navbar>
</ion-header>

<ion-content padding>
  <!--logout link-->
  <span class="logout-button" (click)="logout()">logout</span>

  <!--refresh page-->
  <ion-refresher (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <h3 class="page-header">Your active Quotes and Bids:</h3>

  <ion-col *ngFor="let domestic_quote of domestic_quotes; let i = index">
    <ion-card class="quote-card" [ngClass]="{active: isLevel1Shown('idx'+i)}">
      <div class="bidding-card-main-content">
      <ion-card-header>
        <ion-row class="tiny-date-row">
              <ion-col><span class="bid-history-title">Quote for : {{domestic_quote.date}}; Valid: Until 8 PM</span></ion-col><ion-col></ion-col>
        </ion-row>
        <ion-row>
          <ion-col><span class="header-text">Q-Price</span><br><span class="sub-header-text">(Rs/Kg)</span><br><br><span class="bidding-rate">{{(domestic_quote.rate + expense['delivery_point_cost'])}}</span></ion-col>
          <ion-col><span class="header-text">Last Bid</span><br><span class="sub-header-text">(spc | You)</span><br><br><span class="bidding-rate" *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')">{{domestic_quote.latest_bid_info.spc_rate}}</span> | <span class="bidding-rate" *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')">{{domestic_quote.latest_bid_info.buyer_rate}}</span></ion-col>
          <ion-col> <span class="header-text">Quantity</span><br><span class="sub-header-text">(Bags)</span><br><input type="number" [(ngModel)]="quantity[i]" placeholder="Quantity" class="rate-quantity-input-box"></ion-col>
          <ion-col> <span class="header-text">ETA</span><br>
            <ion-icon name="calendar" class="sub-header-text">
              <ion-datetime class="bidding-rate" displayFormat="DD-MMM-YYYY" [(ngModel)]="delivery_date"></ion-datetime>
            </ion-icon>
            <!-- <input type="date" [(ngModel)]="delivery_date" min="{{today_date}}" class="rate-quantity-input-box"> -->
          </ion-col>
        </ion-row>

        <!-- payment option -->
        <ion-list radio-group>
        <ion-row>
          <ion-col>
              <ion-item style="background-color:inherit">
                <ion-radio value="payment"></ion-radio>
                <ion-label>Payment</ion-label>
              </ion-item>
          </ion-col>

          <ion-col>
            <ion-item style="background-color:inherit">
              <ion-radio value="credit"></ion-radio>
              <ion-label>Credit</ion-label>
            </ion-item>
          </ion-col>
        </ion-row>
      </ion-list>

        <!-- order delivery table -->
        <div *ngIf="isOrderShown('order'+i)">
          <ion-row>
            <!-- if qutoe have a bidding history -->
            <ion-col class="header-text" col-9 *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')" align-item-center>Copra Cost ({{domestic_quote.latest_bid_info.spc_rate}} Rs * {{domestic_quote.latest_bid_info.buyer_quantity}} bags * 50 Kgs)</ion-col>
            <ion-col class="content-text" col-3 *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')" align-item-center>{{domestic_quote.latest_bid_info.spc_rate * domestic_quote.latest_bid_info.buyer_quantity * 50 | number: '.0'}} </ion-col>

            <!-- if quote doesn't have a bidding history -->
            <ion-col class="header-text" col-9 *ngIf="!domestic_quote.hasOwnProperty('latest_bid_info')" align-item-center>Copra Cost ({{(domestic_quote.rate + expense['delivery_point_cost'])}} Rs * {{quantity[i]}} bags * 50 Kgs)</ion-col>
            <ion-col class="content-text" col-3 *ngIf="!domestic_quote.hasOwnProperty('latest_bid_info')" align-item-center>{{(domestic_quote.rate + expense['delivery_point_cost']) * quantity[i] * 50 | number: '.0'}}</ion-col>
          </ion-row>
          <ion-row>
            <ion-col class="header-text" col-6 align-item-center>
            </ion-col>
            <ion-col class="header-text" col-3 align-item-center>charge</ion-col>
            <ion-col class="content-text" col-3 align-item-center>{{door_delivery_cost}}</ion-col>
          </ion-row>
          <hr>
          <ion-row>
            <ion-col col-3 *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')"><button ion-button (click)="checkAvailability(domestic_quote.latest_bid_info.buyer_quantity, delivery_date)">aval</button></ion-col>
            <ion-col col-3 *ngIf="!domestic_quote.hasOwnProperty('latest_bid_info')">
              <button ion-button (click)="checkAvailability(quantity[i], delivery_date, i)">aval<ion-icon *ngIf="is_stock_available == true" name="checkmark" style="font-size:30px;color:green"></ion-icon></button>
            </ion-col>
            <ion-col col-3>
              <button *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')" ion-button (click)="confirmOrder(domestic_quote.latest_bid_info.buyer_quantity, domestic_quote.id, domestic_quote.latest_bid_info.spc_rate, delivery_date, i)">confirm</button>
              <button *ngIf="!domestic_quote.hasOwnProperty('latest_bid_info')" ion-button (click)="confirmOrder(quantity[i], domestic_quote.id, domestic_quote.rate, delivery_date, i)">confirm</button>
            </ion-col>
            <ion-col class="header-text" align-item-center>Total</ion-col>
            <ion-col class="content-text" *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')" align-item-center >{{(domestic_quote.latest_bid_info.spc_rate * domestic_quote.latest_bid_info.buyer_quantity * 50) + door_delivery_cost | number:'.0'}}</ion-col>
            <!-- <ion-col class="content-text" *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')" align-item-center >{{(domestic_quote.latest_bid_info.spc_rate * domestic_quote.latest_bid_info.buyer_quantity) * domestic_quote.latest_bid_info.buyer_quantity + door_delivery_cost}}</ion-col> -->
            <ion-col class="content-text" *ngIf="!domestic_quote.hasOwnProperty('latest_bid_info')" align-item-center >{{(domestic_quote.rate * (quantity[i] * 50)) + (expense['delivery_point_cost'] * (quantity[i] * 50)) + door_delivery_cost | number: '.0'}}</ion-col>
          </ion-row>
          <hr>
        </div>

        <ion-row>
          <ion-col>
        <ion-list>
          <ion-item style="background-color:inherit; padding:0%; margin:0%">
            <ion-label color="primary">Door delivery</ion-label>
            <ion-checkbox (ionChange)="doorDeliveryPickupSelected($event)"></ion-checkbox>
          </ion-item>
        </ion-list>
        </ion-col>
        <ion-col>
          <button ion-button small style="background-color: #C0B283" (click)="toggleLevel1('idx'+i, domestic_quote.id, i)">Bid {{ i }}</button>
        </ion-col>
        <ion-col>
          <button ion-button small style="background-color: rgba(255, 145, 121, 0.95)" (click)="toggleOrder('order'+i, quantity[i], i)">Order</button>
        </ion-col>
      </ion-row>
        <!-- <button ion-button color="secondary" (click)="orderItem(order_quantity, domestic_quote.id, domestic_quote.latest_bid_info.spc_rate, domestic_quote.latest_bid_info.buyer_rate, domestic_quote.latest_bid_info.bid_status)">Order</button> -->
        <!-- <button ion-button small style="background-color: rgba(55, 55, 55, 0.62)" (click)="orderItem(quantity[i], i)">Hold Price</button> -->

      </ion-card-header>
      </div>
    </ion-card>

    <!-- bidding trace/history card -->
    <ion-card class="bidding-trail-card" style="transition: width 2s, height 2s, transform 2s;" *ngIf="isLevel1Shown('idx'+i)">
      <ion-card-header>
        <span><i><b>Bidding trail</b></i></span>
      </ion-card-header>


      <ion-row  *ngFor="let bidding of bidding_history">
        <!--owner side of things-->
        <span *ngIf="bidding.last_bidder.name=='owner'">
          <div class="quote-bubble" [ngClass]="bidding.last_bidder.name=='owner' ? 'speech-bubble-owner' : 'speech-bubble-buyer'">
            <span class="chat-bubble-name">Spc:</span> {{bidding.spc_rate}} Rs.
          </div>
          <span *ngIf="bidding.hasOwnProperty('bid_board_messages')">
            <br>
            <br>
            <span class="message-bubble" *ngFor="let message of bidding.bid_board_messages" [ngClass]="message[1]==1 ? 'speech-bubble-owner' : 'speech-bubble-buyer'">
              {{message[0]}}
            </span>
          </span>
        </span>

        <!--buyer side of things-->
        <ion-row *ngIf="bidding.last_bidder.name!='owner'" >
            <span *ngIf="bidding.hasOwnProperty('buyer_rate')" class="quote-bubble" [ngClass]="bidding.last_bidder.name=='owner' ? 'speech-bubble-owner' : 'speech-bubble-buyer'">
                <span class="chat-bubble-name">You:</span>
                <span>{{bidding.buyer_rate}} Rs. ({{bidding.buyer_quantity}} Bags)</span>
            </span>
            <div *ngIf="bidding.hasOwnProperty('bid_board_messages')">
              <div class="message-bubble" *ngFor="let message of bidding.bid_board_messages" [ngClass]="message[1]==1 ? 'speech-bubble-owner' : 'speech-bubble-buyer'">
                <div><span class="chat-bubble-name">You: </span>{{message[0]}}</div>
              </div>
            </div>
        </ion-row>
      </ion-row>

      <!-- display bidding status -->
      <br> <!-- avoid overlap bidding status to bid rate -->
      <span *ngIf="domestic_quote.hasOwnProperty('latest_bid_info')">
        <span class="bidding-status" *ngIf="domestic_quote.latest_bid_info.bid_status==3">Bid Accepted & Closed</span>
        <span class="bidding-status" *ngIf="domestic_quote.latest_bid_info.bid_status==2">Bidding Expired!</span>
        <span class="bidding-status loading" *ngIf="domestic_quote.latest_bid_info.bid_status==1">Accepting Bidding</span>
      </span>
      <span class="bidding-status" *ngIf="!domestic_quote.hasOwnProperty('latest_bid_info')">Accepting Bidding</span>
        <br>
        <br>
        <br>
        <!--card for bid form and message-->
        <ion-card class="message-bidform-card">
          <span *ngIf="(domestic_quote.hasOwnProperty('latest_bid_info') && domestic_quote.latest_bid_info.bid_status!=3) || !domestic_quote.hasOwnProperty('latest_bid_info')">
            <ion-row>
              <ion-col><input type="text" placeholder="message" [(ngModel)]="message" class="message-input-box"></ion-col>
              <ion-col><button ion-button (click)="onSendMessage(message, domestic_quote.id, i)" class="send-button">Send</button></ion-col>
            </ion-row>

            <span *ngIf="(domestic_quote.hasOwnProperty('latest_bid_info') && domestic_quote.latest_bid_info.bid_status!=3) || !domestic_quote.hasOwnProperty('latest_bid_info')">
              <hr>

              <ion-row>
                <ion-col><span class="header-text">Rate(Rs/Kg)</span><br><input type="number" placeholder="Rate" [(ngModel)]="rate" class="rate-quantity-input-box"></ion-col>
                <ion-col><span class="header-text">Quantity (# bags)</span><br><input type="number" placeholder="50 Kgs bags" [(ngModel)]="quantity[i]" class="rate-quantity-input-box"></ion-col>
                <ion-col><button ion-button (click)="bidding(quantity[i], domestic_quote.id, 'bidding', rate, i)">Bid</button></ion-col>
              </ion-row>
            </span>
          </span>
        </ion-card>
    </ion-card>

  </ion-col>
</ion-content>
